# 简介
   该战斗模块主要适用于多人同屏战斗,前后台代码绝大部分重用
   技能状态全部由前台维护（后台做简单验证）
  
  - 释放技能，由客户端发起，不论成功与否，前端都播放技能，cd照样更新；
    服务端接收到消息后按照正常技能逻辑走，再推送给前端技能释放以及伤害
  
  - 移动前端按照正常移动走，同时通知后台移动，不等后台回调
    每次发起新的移动，会把前端当前位置同时推给后台，保证前后台位置同步
  
  - 自身伤害进入显示队列，正常情况下伤害都会后于技能释放，不会造成不流畅（TODO..）

## 战斗流程

- 客户端副本战斗

                客户端（用户操作）
                  ↓
        ---> 请求层（request）
        |         |
        |         | 更新信息池
        |         | 生成 "战斗事件"
        |         ↓ 
        |   【信息池】fight.Scene：包含场景内所有逻辑数据 ------------------>【显示层】handScene
        |          ↑                                                       演播技能特效、动作、伤害显示
        |          |                                                       模拟移动
        |          | 
        |移动      |  更新信息池
        |使用技能  | 生成 "战斗事件"
        |         |
        对场景进行一次决策(policy.run)
            （技能释放、伤害计算，被动技能、buffer激活，移动位置更新...）
                  ↑            
                  |
            frame_mrg (fight.FMgr) 

- 同屏战斗

                net websocket 同步前台操作到后台
              ↧¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯|
            服务端                |    客户端                
              ↓                   |       ↓                  
            请求层（request）       |  请求层（request）<-------------------------------
              |                     |     |              |                           |
              |     判断请求是否合理  |    |              | 需要同步后台的事件          |
              |     更新信息池        |   |               | 如：移动、使用技能          |
              |     并生成 "战斗事件"  |  |               |                            |
              |                       ¯¯¯|               |                            |
              ↓                          ↓               |      接收战斗事件           |
        --|  【信息池】fight.Scene：包含场景内所有逻辑数据  |    |____________           |
        |   （玩家、玩家技能，玩家buff...）                |                 |          |
        |     ↑                          ↑               |                 |          |一部分后台状态同步到前台模拟场景
        |     | 更新信息池、生成 "战斗事件"|               |                 |          |如：moveto,伤害血量等
        |     |                          |               ↑                 |          |
        |   对场景进行一次决策(policy.run) |¯¯¯¯¯¯¯¯¯¯¯¯¯¯¯                  |          |
        |   （技能释放、伤害计算，被动技能、buffer激活，移动位置更新...）       |          |
        |     ↑                          ↑                                 |          |
        |     |    按照固定帧率(50ms)     |                                 |          |
        |     |                          |                                 |          |
        |   erlang->v8              frame_mrg (fight.FMgr)                 |          |
        |   服务端                     客户端                               |          |
        |                                                                  |          |
        |                                                                  |          |
        |                                                                  ↓          |
        |_______net websocket----------------------------------> 【同屏模块】same ¯¯¯¯¯¯  
                                                                  处理前后台事件
                                                                          |
                                                                          |
                                                                          ↓
                                                                     【显示层】handScene
                                                                   演播技能特效、动作、伤害显示
                                                                   模拟移动



